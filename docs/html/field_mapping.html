<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Mapping - AV Catalog Converter Documentation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
        }
        h1 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        h3 {
            margin-top: 25px;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow: auto;
            position: relative;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-btn:hover {
            background-color: #2980b9;
        }
        .command-container {
            position: relative;
            margin-bottom: 15px;
        }
        ul, ol {
            padding-left: 25px;
        }
        .endpoint {
            background-color: #f0f7fb;
            border-left: 5px solid #3498db;
            padding: 10px;
            margin-bottom: 15px;
        }
        .project-structure {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre;
            line-height: 1.3;
        }
        .component {
            background-color: #f9f9f9;
            border-left: 3px solid #2ecc71;
            padding: 10px;
            margin-bottom: 10px;
        }
        .note {
            background-color: #fff8dc;
            border-left: 5px solid #f1c40f;
            padding: 10px;
            margin-bottom: 15px;
        }
        .warning {
            background-color: #ffebee;
            border-left: 5px solid #f44336;
            padding: 10px;
            margin-bottom: 15px;
        }
        .toc {
            background-color: #f8f9fa;
            border: 1px solid #eaecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .toc ul {
            list-style-type: none;
            padding-left: 15px;
        }
        .toc li {
            margin-bottom: 5px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .breadcrumb {
            margin-bottom: 20px;
            font-size: 14px;
        }
        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="breadcrumb">
        <a href="index.html">Home</a> &gt; <a href="data_pipeline.html">Data Processing Pipeline</a> &gt; Field Mapping
    </div>

    <h1>Field Mapping</h1>
    
    <div class="toc">
        <h2>Table of Contents</h2>
        <ul>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#components">Components</a>
                <ul>
                    <li><a href="#field-mapper">Field Mapper</a></li>
                    <li><a href="#direct-mapper">Direct Mapper</a></li>
                    <li><a href="#pattern-mapper">Pattern Mapper</a></li>
                    <li><a href="#semantic-mapper">Semantic Mapper</a></li>
                </ul>
            </li>
            <li><a href="#mapping-process">Mapping Process</a>
                <ul>
                    <li><a href="#user-mappings">User-Provided Mappings</a></li>
                    <li><a href="#direct-matching">Direct Header Matching</a></li>
                    <li><a href="#pattern-matching">Pattern-Based Mapping</a></li>
                    <li><a href="#semantic-mapping">AI-Assisted Semantic Mapping</a></li>
                </ul>
            </li>
            <li><a href="#standard-schema">Standard Schema</a></li>
            <li><a href="#manufacturer-patterns">Manufacturer-Specific Patterns</a></li>
            <li><a href="#usage">Usage Examples</a></li>
            <li><a href="#customization">Customization</a></li>
        </ul>
    </div>

    <h2 id="overview">Overview</h2>
    <p>
        The Field Mapping component is responsible for mapping input columns to the standardized schema fields.
        It uses a multi-stage approach combining direct matching, pattern matching, and AI-assisted semantic mapping
        to achieve high accuracy even with diverse and complex input formats.
    </p>
    <p>
        The Field Mapping component is designed to be:
    </p>
    <ul>
        <li><strong>Accurate</strong> - Uses multiple strategies to ensure correct mappings</li>
        <li><strong>Flexible</strong> - Adapts to different input formats and naming conventions</li>
        <li><strong>Intelligent</strong> - Leverages AI for semantic understanding of field meanings</li>
        <li><strong>Customizable</strong> - Supports user-provided mappings and manufacturer-specific patterns</li>
    </ul>

    <h2 id="components">Components</h2>
    
    <h3 id="field-mapper">Field Mapper</h3>
    <p>
        The <code>FieldMapper</code> class is the main entry point for field mapping. It coordinates the mapping
        process and integrates the results from various mapping strategies.
    </p>
    <div class="component">
        <h4>Key Methods</h4>
        <ul>
            <li><code>map(data, structure_info)</code> - Maps input data to standardized schema</li>
            <li><code>map_fields(columns, sample_rows)</code> - Maps fields using AI assistance</li>
            <li><code>_detect_manufacturer(data)</code> - Detects the manufacturer from the data</li>
            <li><code>_apply_mappings(data, mappings)</code> - Applies field mappings to a DataFrame</li>
        </ul>
    </div>

    <h3 id="direct-mapper">Direct Mapper</h3>
    <p>
        The <code>DirectMapper</code> class maps fields based on direct name matching. It uses exact matches,
        case-insensitive matches, and fuzzy matches to identify corresponding fields.
    </p>
    <div class="component">
        <h4>Key Methods</h4>
        <ul>
            <li><code>map_fields(columns, already_mapped=[])</code> - Maps fields based on direct matching</li>
            <li><code>get_exact_matches(columns)</code> - Gets exact matches between columns and schema fields</li>
            <li><code>get_fuzzy_matches(columns)</code> - Gets fuzzy matches based on string similarity</li>
        </ul>
    </div>

    <h3 id="pattern-mapper">Pattern Mapper</h3>
    <p>
        The <code>PatternMapper</code> class maps fields based on pattern matching. It uses regular expressions
        and manufacturer-specific patterns to identify fields.
    </p>
    <div class="component">
        <h4>Key Methods</h4>
        <ul>
            <li><code>map_fields(data, manufacturer=None, already_mapped=[])</code> - Maps fields based on patterns</li>
            <li><code>get_manufacturer_patterns(manufacturer)</code> - Gets patterns for a specific manufacturer</li>
            <li><code>apply_patterns(data, patterns)</code> - Applies patterns to identify fields</li>
        </ul>
    </div>

    <h3 id="semantic-mapper">Semantic Mapper</h3>
    <p>
        The <code>SemanticMapper</code> class maps fields based on semantic similarity using the LLM integration.
        It provides AI-assisted mapping for fields that cannot be mapped using simpler methods.
    </p>
    <div class="component">
        <h4>Key Methods</h4>
        <ul>
            <li><code>map_fields(data, structure_info, already_mapped=[])</code> - Maps fields using semantic similarity</li>
            <li><code>prepare_sample_data(data)</code> - Prepares sample data for the LLM</li>
            <li><code>generate_mapping_prompt(columns, sample_data, structure_info)</code> - Generates prompt for the LLM</li>
            <li><code>parse_mapping_response(response)</code> - Parses the LLM response into mappings</li>
        </ul>
    </div>

    <h2 id="mapping-process">Mapping Process</h2>
    
    <h3 id="user-mappings">User-Provided Mappings</h3>
    <p>
        The first stage of the mapping process applies user-provided mappings if available. These mappings
        take precedence over all other mapping methods.
    </p>
    <div class="component">
        <h4>User Mapping Example</h4>
        <pre><code>field_mapper = FieldMapper()
field_mapper.user_mappings = {
    "Product Code": "SKU",
    "Product Name": "Short Description",
    "Detailed Description": "Long Description",
    "Brand": "Manufacturer"
}
mapped_data = field_mapper.map(data, structure_info)</code></pre>
    </div>

    <h3 id="direct-matching">Direct Header Matching</h3>
    <p>
        The second stage applies direct header matching for unmapped fields. It uses exact matches,
        case-insensitive matches, and fuzzy matches to identify corresponding fields.
    </p>
    <div class="component">
        <h4>Direct Matching Strategies</h4>
        <ul>
            <li><strong>Exact Match</strong> - Column name exactly matches schema field</li>
            <li><strong>Case-Insensitive Match</strong> - Column name matches schema field ignoring case</li>
            <li><strong>Normalized Match</strong> - Column name matches schema field after normalization (removing spaces, underscores, etc.)</li>
            <li><strong>Fuzzy Match</strong> - Column name is similar to schema field (Levenshtein distance)</li>
        </ul>
    </div>

    <h3 id="pattern-matching">Pattern-Based Mapping</h3>
    <p>
        The third stage applies pattern-based mapping for specific fields. It uses regular expressions
        and manufacturer-specific patterns to identify fields based on their content.
    </p>
    <div class="component">
        <h4>Pattern Matching Examples</h4>
        <ul>
            <li><strong>SKU</strong> - Alphanumeric codes with specific formats</li>
            <li><strong>Model</strong> - Manufacturer-specific model number patterns</li>
            <li><strong>Price</strong> - Values with currency symbols or price-related column names</li>
            <li><strong>URL</strong> - Web URLs with specific domains or patterns</li>
        </ul>
    </div>

    <h3 id="semantic-mapping">AI-Assisted Semantic Mapping</h3>
    <p>
        The final stage applies AI-assisted semantic mapping for remaining unmapped fields. It uses the LLM integration
        to understand the semantic meaning of columns and map them to the appropriate schema fields.
    </p>
    <div class="component">
        <h4>Semantic Mapping Process</h4>
        <ol>
            <li>Prepare sample data from the input</li>
            <li>Generate a prompt with column names, sample data, and structure information</li>
            <li>Send the prompt to the LLM</li>
            <li>Parse the LLM response into field mappings</li>
            <li>Validate and apply the mappings</li>
        </ol>
    </div>

    <h2 id="standard-schema">Standard Schema</h2>
    <p>
        The field mapping process maps input columns to a standardized schema defined in <code>config/schema.py</code>.
        The standard schema includes the following fields:
    </p>
    <table>
        <tr>
            <th>Field</th>
            <th>Description</th>
            <th>Required</th>
        </tr>
        <tr>
            <td>SKU</td>
            <td>Unique identifier for the product</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>Short Description</td>
            <td>Brief product description</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>Long Description</td>
            <td>Detailed product description</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Model</td>
            <td>Product model number</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Category Group</td>
            <td>Top-level product category</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Category</td>
            <td>Product category</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Manufacturer</td>
            <td>Product manufacturer/brand</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>Manufacturer SKU</td>
            <td>Manufacturer's product code</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Image URL</td>
            <td>URL to product image</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Document Name</td>
            <td>Name of associated document</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Document URL</td>
            <td>URL to associated document</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Unit Of Measure</td>
            <td>Unit of measurement</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Buy Cost</td>
            <td>Wholesale cost</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Trade Price</td>
            <td>Trade/dealer price</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>MSRP GBP</td>
            <td>Manufacturer's suggested retail price in GBP</td>
            <td>No</td>
        </tr>
        <tr>
            <td>MSRP USD</td>
            <td>Manufacturer's suggested retail price in USD</td>
            <td>No</td>
        </tr>
        <tr>
            <td>MSRP EUR</td>
            <td>Manufacturer's suggested retail price in EUR</td>
            <td>No</td>
        </tr>
        <tr>
            <td>Discontinued</td>
            <td>Whether the product is discontinued</td>
            <td>No</td>
        </tr>
    </table>

    <h2 id="manufacturer-patterns">Manufacturer-Specific Patterns</h2>
    <p>
        The Field Mapper includes manufacturer-specific patterns to improve mapping accuracy for known manufacturers.
        These patterns are defined in <code>manufacturer_patterns.json</code> and loaded by the <code>FieldMapper</code>.
    </p>
    <div class="component">
        <h4>Example Manufacturer Patterns</h4>
        <pre><code>{
    "sony": {
        "model_pattern": "[A-Z]{3}-[A-Z0-9]{5,7}",
        "sku_prefix": "SNY-"
    },
    "samsung": {
        "model_pattern": "[A-Z]{2}[0-9]{2}[A-Z][0-9]{4,5}",
        "sku_prefix": "SAM-"
    },
    "lg": {
        "model_pattern": "[0-9]{2}[A-Z]{2}[0-9]{2,3}[A-Z]{1,2}",
        "sku_prefix": "LG-"
    }
}</code></pre>
    </div>

    <h2 id="usage">Usage Examples</h2>
    <p>
        Here's a simple example of how to use the Field Mapper:
    </p>
    <pre><code>from services.mapping.field_mapper import FieldMapper
from services.structure.structure_analyzer import StructureAnalyzer
import pandas as pd

# Load data
data = pd.read_csv('catalog.csv')

# Analyze structure
analyzer = StructureAnalyzer()
structure_info = analyzer.analyze(data)

# Create field mapper
field_mapper = FieldMapper()

# Add user-provided mappings (optional)
field_mapper.user_mappings = {
    "Product Code": "SKU",
    "Product Name": "Short Description"
}

# Map fields
mapped_data = field_mapper.map(data, structure_info)

# Print mapping results
print("Mapping results:")
for source, target in field_mapper.last_mapping_results.items():
    print(f"  - {source} -> {target}")

# Print mapped columns
print("\nMapped columns:")
for col in mapped_data.columns:
    print(f"  - {col}")</code></pre>

    <p>
        Example of using the <code>map_fields</code> method for API integration:
    </p>
    <pre><code>from services.mapping.field_mapper import FieldMapper

# Create field mapper
field_mapper = FieldMapper()

# Define columns and sample data
columns = ["product_id", "name", "description", "brand", "price"]
sample_rows = [
    ["ABC123", "Sony 65-inch TV", "4K OLED TV with HDR", "Sony", "1299.99"],
    ["DEF456", "Samsung Soundbar", "Dolby Atmos Soundbar", "Samsung", "499.99"]
]

# Map fields
mapping_results = field_mapper.map_fields(columns, sample_rows)

# Print mapping results
print("Mapping results:")
for mapping in mapping_results.get('mappings', []):
    print(f"  - {mapping['source_field']} -> {mapping['target_field']} (confidence: {mapping['confidence']})")
    print(f"    Reasoning: {mapping['reasoning']}")</code></pre>

    <h2 id="customization">Customization</h2>
    <p>
        The Field Mapper can be customized in several ways:
    </p>
    <ul>
        <li><strong>User-Provided Mappings</strong> - Set <code>user_mappings</code> to provide explicit mappings</li>
        <li><strong>Manufacturer Patterns</strong> - Add or modify manufacturer-specific patterns</li>
        <li><strong>Custom Mapping Strategies</strong> - Extend the mapper with custom mapping strategies</li>
        <li><strong>Mapping Thresholds</strong> - Adjust confidence thresholds in <code>config/settings.py</code></li>
    </ul>
    <p>
        Example of adding a custom mapping strategy:
    </p>
    <pre><code>from services.mapping.field_mapper import FieldMapper

class CustomFieldMapper(FieldMapper):
    def __init__(self):
        super().__init__()
        self.custom_mapper = CustomMapper()
    
    def map(self, data, structure_info):
        # Apply standard mapping stages
        mapping_results = {}
        
        # Apply user-provided mappings
        if self.user_mappings:
            mapping_results = self.user_mappings.copy()
        
        # Apply direct header matching
        direct_mappings = self.direct_mapper.map_fields(
            data.columns,
            already_mapped=list(mapping_results.values())
        )
        for source, target in direct_mappings.items():
            if target not in mapping_results.values():
                mapping_results[source] = target
        
        # Apply custom mapping strategy
        custom_mappings = self.custom_mapper.map_fields(
            data,
            already_mapped=list(mapping_results.values())
        )
        for source, target in custom_mappings.items():
            if target not in mapping_results.values():
                mapping_results[source] = target
        
        # Apply remaining standard stages
        # ...
        
        # Apply the mappings
        standardized_df = self._apply_mappings_dict(data, mapping_results)
        self.last_mapping_results = mapping_results
        
        return standardized_df</code></pre>

    <div class="note">
        <p>
            <strong>Note:</strong> For more detailed information about field mapping, refer to the source code in the <code>services/mapping</code> directory.
        </p>
    </div>

    <script>
        function copyToClipboard(button) {
            const pre = button.previousElementSibling;
            const text = pre.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
    </script>
</body>
</html>
